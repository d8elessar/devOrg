# Unique name for this workflow
name: Deploy test branch to test/uat orgs

# Definition when the workflow should run
on:
    push:
        branches: [test]
        paths:
            - "force-app/**"

# Jobs to be executed
jobs:
    deploy-branch-to-test-org:
        runs-on: self-hosted
        if: ${{ github.actor != 'dependabot[bot]' }}
        steps:
            # Checkout the source code
            - name: "Checkout source code"
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            # Store secret for org
            - name: "Populate auth file with SFDX_URL secret of the test org"
              shell: bash
              run: |
                  echo ${{ secrets.SFDX_TEST_URL}} > ./.github/SFDX_TEST_URL.txt

            # Create delta package
            - name: "Create delta packages for new, modified or deleted metadata"
              run: |
                  mkdir changed-sources
                  sfdx sgd:source:delta --to "HEAD" --from "HEAD^" --output changed-sources/ --generate-delta --source force-app/

            # Authenticate to org
            - name: "Authenticate to Test/UAT Org"
              run: sfdx auth:sfdxurl:store -f ./.github/SFDX_TEST_URL.txt -s -a test

            - name: Check if destructiveChanges file exists and set variable
              id: check_file
              run: |
                  if test -f "changed-sources/destructiveChanges/destructiveChanges.xml"; then
                    echo "FILE_EXISTS=--pre-destructive-changes changed-sources/destructiveChanges/destructiveChanges.xml" >> $GITHUB_ENV
                  fi

            # Deploy to org
            - name: "Deploy delta changes - run all tests"
              if: ${{ env.APEX_TESTS == 'all' }}
              run: |
                  set +e
                  sf project deploy start --manifest changed-sources/package/package.xml ${{env.FILE_EXISTS}} --test-level RunLocalTests --json --coverage-formatters cobertura --results-dir ./ > ./.github/stepOutput.txt
                  set -e
